<script>
    // Supabase credentials.
    const SUPABASE_URL = 'https://kiqfxehakdabwbqdpblx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpcWZ4ZWhha2RhYndicWRwYmx4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzA0ODgsImV4cCI6MjA3MzYwNjQ4OH0.HF_TgfMxNOVKGXHie0QGG_RsX-P9QvuTty4Wk3Hn_Fs';
    const CUSTOMERS_TABLE_NAME = 'Das';

    // Initialize Supabase client
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Event listener for the FINCON CODE input field
    document.getElementById('finconCode').addEventListener('change', async (event) => {
        const finconCode = event.target.value.trim().toUpperCase();
        if (finconCode) {
            try {
                // ✅ CORRECTED QUERY: Quotes added to column names with spaces
                const { data: customer, error } = await _supabase
                    .from(CUSTOMERS_TABLE_NAME)
                    .select('"Client Type", "Contact Name", "Contact Title", "Contact details", "Area of interest"')
                    .eq('"FINCON CODE"', finconCode) // <-- Corrected this line
                    .single(); // <-- Using .single() is cleaner

                if (error) {
                    // If .single() finds no row, it returns an error, which we can handle gracefully.
                    if (error.code === 'PGRST116') {
                        // Clear the form if no match is found
                        document.getElementById('inputForm').reset();
                        // Re-set the finconCode as reset() clears everything
                        document.getElementById('finconCode').value = finconCode; 
                        alert('No customer found with that FINCON CODE.');
                    } else {
                        throw error; // For other types of errors
                    }
                }
                
                // ✅ SIMPLIFIED DATA HANDLING: .single() returns an object directly
                if (customer) {
                    document.getElementById('clientType').value = customer['Client Type'] || '';
                    document.getElementById('contactName').value = customer['Contact Name'] || '';
                    document.getElementById('contactTitle').value = customer['Contact Title'] || '';
                    document.getElementById('contactDetails').value = customer['Contact details'] || '';
                    document.getElementById('areaOfInterest').value = customer['Area of interest'] || '';
                }

            } catch (error) {
                console.error('Lookup failed:', error.message);
                alert('An error occurred during lookup. Check the console for details.');
            }
        }
    });

    // Function to format a date to MM-YY
    function formatPeriod(dateInput) {
        if (!dateInput) return '';
        const date = new Date(dateInput);
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear().toString().slice(-2);
        return `${month}-${year}`;
    }

    // Event listener for the Open date field to populate Open Period
    document.getElementById('openDate').addEventListener('change', (event) => {
        document.getElementById('openPeriod').value = formatPeriod(event.target.value);
    });

    // Event listener for the Invoice date field to populate Invoice Period
    document.getElementById('invoiceDate').addEventListener('change', (event) => {
        document.getElementById('invoicePeriod').value = formatPeriod(event.target.value);
    });

    // Prevent form submission
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById("inputForm").addEventListener("submit", (e) => e.preventDefault());
    });
</script>
