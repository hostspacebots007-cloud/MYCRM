<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAS OT - CRM Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: #333;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .dashboard-card {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .full-width {
            grid-column: span 2;
        }
        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            background-color: #f9f9f9;
            transition: background-color 0.3s;
        }
        .tab-button.active {
            background-color: white;
            border: 1px solid #ddd;
            border-bottom: none;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .status-indicator {
            padding: 4px 8px;
            border-radius: 12px;
            color: white;
            font-size: 12px;
        }
        .status-open { background-color: #007bff; }
        .status-awaiting-response-to-quote { background-color: #ffc107; }
        .status-won { background-color: #28a745; }
        .status-lost { background-color: #dc3545; }
        .progress-bar {
            background-color: #e9ecef;
            border-radius: 5px;
            height: 20px;
            margin-top: 10px;
        }
        .progress-fill {
            background-color: #28a745;
            height: 100%;
            border-radius: 5px;
            width: 0%;
            transition: width 0.4s ease;
        }
        .login-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
            max-width: 400px;
            margin: 50px auto;
        }
        .login-section input {
            margin-bottom: 10px;
        }
         
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <div class="container">
        <header>
            <h1>DAS OT - CRM Dashboard</h1>
        </header>
         
        <div class="tab-buttons">
            <button class="tab-button active" onclick="openTab('dashboard')">Dashboard</button>
            <button class="tab-button" onclick="openTab('add-opportunity')">Add New Opportunity</button>
            <button class="tab-button" onclick="openTab('customer-data')">Customer Data</button>
            <button class="tab-button" onclick="openTab('login-signup')">Login / Sign-up</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <h2>Dashboard Overview</h2>
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3>Total Opportunities Value (P)</h3>
                    <p id="totalOpportunities">0.00</p>
                </div>
                <div class="dashboard-card">
                    <h3>Total Sales Value (P)</h3>
                    <p id="totalSales">0.00</p>
                </div>
                <div class="dashboard-card">
                    <h3>Close Rate (%)</h3>
                    <p id="closeRate">0.00%</p>
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                </div>
            </div>

            <h3>Recent Opportunities</h3>
            <table id="opportunitiesTable">
                <thead>
                    <tr>
                        <th>Fincon Code</th>
                        <th>Client</th>
                        <th>Quote Number</th>
                        <th>Client Type</th>
                        <th>Contact Name</th>
                        <th>Contact Title</th>
                        <th>Area of Interest</th>
                        <th>Open Date</th>
                        <th>Opportunity Value (P)</th>
                        <th>Mode of Sale</th>
                        <th>Status</th>
                        <th>Sales Made (P)</th>
                        <th>Close Date</th>
                    </tr>
                </thead>
                <tbody id="opportunitiesBody">
                    </tbody>
            </table>
        </div>

        <div id="add-opportunity" class="tab-content">
            <h2>Add New Sales Opportunity</h2>
            <form id="inputForm">
                <div class="form-grid">
                    <div>
                        <label for="finconCode">Fincon Code:</label>
                        <input type="text" id="finconCode" name="finconCode" oninput="lookupCustomer()">
                    </div>
                    <div>
                        <label for="client">Client:</label>
                        <input type="text" id="client" name="client">
                    </div>
                    <div>
                        <label for="quoteNumber">Quote Number:</label>
                        <input type="text" id="quoteNumber" name="quoteNumber">
                    </div>
                    <div>
                        <label for="clientType">Client Type:</label>
                        <input type="text" id="clientType" name="clientType">
                    </div>
                    <div>
                        <label for="contactName">Contact Name:</label>
                        <input type="text" id="contactName" name="contactName">
                    </div>
                    <div>
                        <label for="contactTitle">Contact Title:</label>
                        <input type="text" id="contactTitle" name="contactTitle">
                    </div>
                    <div>
                        <label for="contactDetails">Contact Details:</label>
                        <input type="text" id="contactDetails" name="contactDetails">
                    </div>
                    <div>
                        <label for="areaInterest">Area of Interest:</label>
                        <input type="text" id="areaInterest" name="areaInterest">
                    </div>
                    <div>
                        <label for="openDate">Open Date:</label>
                        <input type="date" id="openDate" name="openDate">
                    </div>
                    <div>
                        <label for="openPeriod">Open Period:</label>
                        <input type="text" id="openPeriod" name="openPeriod">
                    </div>
                    <div>
                        <label for="opportunityValue">Opportunity Value:</label>
                        <input type="number" id="opportunityValue" name="opportunityValue">
                    </div>
                    <div>
                        <label for="likelihood">Likelihood:</label>
                        <select id="likelihood" name="likelihood">
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div>
                        <label for="modeOfSale">Mode of Sale:</label>
                        <select id="modeOfSale" name="modeOfSale">
                            <option value="walk-in">Walk-in</option>
                            <option value="email">Email</option>
                            <option value="call">Call</option>
                            <option value="visit">Visit</option>
                        </select>
                    </div>
                    <div>
                        <label for="status">Status:</label>
                        <select id="status" name="status">
                            <option value="open">Open</option>
                            <option value="awaiting-response-to-quote">Awaiting Response to Quote</option>
                            <option value="won">Won</option>
                            <option value="lost">Lost</option>
                        </select>
                    </div>
                    <div>
                        <label for="salesMade">Sales Made:</label>
                        <input type="number" id="salesMade" name="salesMade" value="0">
                    </div>
                    <div>
                        <label for="closeDate">Close Date:</label>
                        <input type="date" id="closeDate" name="closeDate">
                    </div>
                    <div>
                        <label for="closePeriod">Close Period:</label>
                        <input type="text" id="closePeriod" name="closePeriod">
                    </div>
                    <div class="full-width">
                        <label for="comments">Comments:</label>
                        <textarea id="comments" name="comments" rows="4"></textarea>
                    </div>
                </div>
                <button type="button" onclick="addSalesOpportunity()">Submit Opportunity</button>
            </form>
        </div>
         
        <div id="customer-data" class="tab-content">
            <h2>Customer Data</h2>
            <input type="text" id="customerSearch" oninput="filterCustomers()" placeholder="Search customers...">
            <table>
                <thead>
                    <tr>
                        <th>ACCNO</th>
                        <th>Company Name</th>
                        <th>Contact Person</th>
                        <th>Number</th>
                        <th>Designation</th>
                        <th>Area of Interest</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="customersBody">
                    </tbody>
            </table>
        </div>

        <div id="login-signup" class="tab-content">
            <div class="login-section">
                <h2>Sign Up / Log In</h2>
                <input type="email" id="authEmail" placeholder="Email">
                <input type="password" id="authPassword" placeholder="Password">
                <button onclick="signUp(document.getElementById('authEmail').value, document.getElementById('authPassword').value)">Sign Up</button>
                <button onclick="signIn(document.getElementById('authEmail').value, document.getElementById('authPassword').value)">Log In</button>
            </div>
        </div>

    </div>

    <script>
        const SUPABASE_URL = 'https://kiqfxehakdabwbqdpblx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpcWZ4ZWhha2RhYndicWRwYmx4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzA0ODgsImV4cCI6MjA3MzYwNjQ4OH0.HF_TgfMxNOVKGXHie0QGG_RsX-P9QvuTty4Wk3Hn_Fs';
        const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // User Authentication and State Management
        let currentUser = null;
        let customers = [];
        let opportunities = [];

        supabase.auth.onAuthStateChange((event, session) => {
            if (session) {
                currentUser = session.user;
                // Fetch data for the current user once logged in
                fetchCustomers();
                fetchOpportunities();
            } else {
                currentUser = null;
                // Handle logged-out state
                alert('Please log in to use the CRM.');
                customers = [];
                opportunities = [];
                renderCustomers();
                renderOpportunities();
                updateDashboard();
            }
        });

        // Functions to interact with Supabase
        async function fetchCustomers() {
            const { data, error } = await supabase.from('customers').select('*');
            if (error) {
                console.error('Error fetching customers:', error);
            } else {
                customers = data;
                renderCustomers();
            }
        }

        async function fetchOpportunities() {
            const { data, error } = await supabase.from('opportunities').select('*');
            if (error) {
                console.error('Error fetching opportunities:', error);
            } else {
                opportunities = data;
                renderOpportunities();
                updateDashboard(opportunities);
            }
        }

        // Update existing functions to use Supabase instead of in-memory data
        function lookupCustomer() {
            const customerCode = document.getElementById("finconCode").value.toUpperCase();
            const customer = customers.find(c => c.accno === customerCode);
            if (customer) {
                document.getElementById("client").value = customer.companyName;
                document.getElementById("contactName").value = customer.contactPerson;
                document.getElementById("contactTitle").value = customer.designation;
                document.getElementById("contactDetails").value = customer.number;
                document.getElementById("areaInterest").value = customer.areaOfInterest;
                document.getElementById("finconCode").value = customer.accno; // Ensures the Fincon code is set
            } else {
                // Clear fields if no customer is found
                document.getElementById("client").value = "";
                document.getElementById("contactName").value = "";
                document.getElementById("contactTitle").value = "";
                document.getElementById("contactDetails").value = "";
                document.getElementById("areaInterest").value = "";
            }
        }

        async function addSalesOpportunity() {
            if (!currentUser) {
                alert("You must be logged in to add a sales opportunity.");
                return;
            }
            
            const newOpportunity = {
                finconCode: document.getElementById("finconCode").value,
                client: document.getElementById("client").value,
                quoteNumber: document.getElementById("quoteNumber").value,
                clientType: document.getElementById("clientType").value,
                contactName: document.getElementById("contactName").value,
                contactTitle: document.getElementById("contactTitle").value,
                contactDetails: document.getElementById("contactDetails").value,
                areaInterest: document.getElementById("areaInterest").value,
                openDate: document.getElementById("openDate").value,
                openPeriod: document.getElementById("openPeriod").value,
                opportunityValue: parseFloat(document.getElementById("opportunityValue").value),
                likelihood: document.getElementById("likelihood").value,
                modeOfSale: document.getElementById("modeOfSale").value,
                status: document.getElementById("status").value,
                salesMade: parseFloat(document.getElementById("salesMade").value) || 0,
                closeDate: document.getElementById("closeDate").value,
                closePeriod: document.getElementById("closePeriod").value,
                comments: document.getElementById("comments").value
            };

            const { data, error } = await supabase.from('opportunities').insert([newOpportunity]);
            if (error) {
                console.error('Error adding sales opportunity:', error);
                alert("Error adding sales opportunity. See console for details.");
            } else {
                alert("Sales opportunity added successfully!");
                document.getElementById("inputForm").reset();
                fetchOpportunities(); // Re-fetch data to update the table
            }
        }

        function renderOpportunities() {
            const tableBody = document.getElementById("opportunitiesBody");
            tableBody.innerHTML = '';
            opportunities.forEach(opp => {
                const row = document.createElement('tr');
                const statusClass = opp.status.toLowerCase().replace(/\s/g, '-');
                row.innerHTML = `
                    <td>${opp.finconCode}</td>
                    <td>${opp.client}</td>
                    <td>${opp.quoteNumber}</td>
                    <td>${opp.clientType}</td>
                    <td>${opp.contactName}</td>
                    <td>${opp.contactTitle}</td>
                    <td>${opp.areaInterest}</td>
                    <td>${opp.openDate}</td>
                    <td>${opp.opportunityValue ? opp.opportunityValue.toFixed(2) : '0.00'}</td>
                    <td>${opp.modeOfSale}</td>
                    <td><span class="status-indicator status-${statusClass}">${opp.status}</span></td>
                    <td>${opp.salesMade ? opp.salesMade.toFixed(2) : '0.00'}</td>
                    <td>${opp.closeDate}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function renderCustomers() {
            const tableBody = document.getElementById("customersBody");
            tableBody.innerHTML = '';
            customers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.accno}</td>
                    <td>${customer.companyName}</td>
                    <td>${customer.contactPerson}</td>
                    <td>${customer.number}</td>
                    <td>${customer.designation}</td>
                    <td>${customer.areaOfInterest}</td>
                    <td>
                        <button onclick="editCustomer('${customer.accno}')">Edit</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function filterCustomers() {
            const searchTerm = document.getElementById("customerSearch").value.toLowerCase();
            const filteredCustomers = customers.filter(customer =>
                Object.values(customer).some(value =>
                    value && value.toString().toLowerCase().includes(searchTerm)
                )
            );
            const tableBody = document.getElementById("customersBody");
            tableBody.innerHTML = '';
            filteredCustomers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.accno}</td>
                    <td>${customer.companyName}</td>
                    <td>${customer.contactPerson}</td>
                    <td>${customer.number}</td>
                    <td>${customer.designation}</td>
                    <td>${customer.areaOfInterest}</td>
                    <td>
                        <button onclick="editCustomer('${customer.accno}')">Edit</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function updateDashboard(opportunities) {
            const totalOpportunitiesValue = opportunities.reduce((sum, opp) => sum + (opp.opportunityValue || 0), 0);
            const totalSalesValue = opportunities.reduce((sum, opp) => sum + (opp.salesMade || 0), 0);
            const wonOpportunities = opportunities.filter(opp => opp.status && opp.status.toLowerCase() === 'won');
            const closeRate = opportunities.length > 0 ? (wonOpportunities.length / opportunities.length) * 100 : 0;

            document.getElementById('totalOpportunities').textContent = totalOpportunitiesValue.toFixed(2);
            document.getElementById('totalSales').textContent = totalSalesValue.toFixed(2);
            document.getElementById('closeRate').textContent = `${closeRate.toFixed(2)}%`;
            document.querySelector('.progress-fill').style.width = `${closeRate}%`;
        }
         
        // This function is new and not fully implemented yet, but will allow editing
        function editCustomer(accno) {
            alert(`Edit customer functionality for ${accno} will be added later!`);
        }
         
        function openTab(tabId) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');

            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`[onclick="openTab('${tabId}')"]`).classList.add('active');
        }

        // Initial render on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await renderOpportunities();
            await renderCustomers();
            // This needs to be done here to ensure the form can be reset
            document.getElementById("inputForm").addEventListener("submit", (e) => e.preventDefault());
        });

        // Functions for Authentication
        async function signUp(email, password) {
            const { user, error } = await supabase.auth.signUp({
                email: email,
                password: password
            });
            if (error) {
                alert(error.message);
            } else {
                alert('Sign up successful! Please check your email for a confirmation link.');
            }
        }

        async function signIn(email, password) {
            const { user, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });
            if (error) {
                alert(error.message);
            } else {
                alert('Login successful!');
                openTab('dashboard');
            }
        }

        // Add a logout function
        async function signOut() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                alert(error.message);
            } else {
                alert('You have been logged out.');
                openTab('login-signup'); // Redirect to login page
            }
        }
         
    </script>
</body>
</html>
