<script>
    // 1. Supabase Initialization
    // Replace these with your actual Supabase project URL and anon key
    const SUPABASE_URL = 'https://kiqfxehakdabwbqdpblx.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtpcWZ4ZWhha2RhYndicWRwYmx4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzA0ODgsImV4cCI6MjA3MzYwNjQ4OH0.HF_TgfMxNOVKGXHie0QGG_RsX-P9QvuTty4Wk3Hn_Fs';

const { createClient } = supabase;
const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 2. User Authentication and State Management
    let currentUser = null;
    let customers = [];
    let opportunities = [];

    _supabase.auth.onAuthStateChange((event, session) => {
        if (session) {
            currentUser = session.user;
            // Fetch data for the current user once logged in
            fetchCustomers();
            fetchOpportunities();
        } else {
            currentUser = null;
            // Handle logged-out state, e.g., redirect to login page
            // For now, we'll just show an alert and clear data
            alert('Please log in to use the CRM.');
            customers = [];
            opportunities = [];
            renderCustomers();
            renderOpportunities();
            updateDashboard();
        }
    });

    // 3. Functions to interact with Supabase
    async function fetchCustomers() {
        const { data, error } = await _supabase.from('customers').select('*');
        if (error) {
            console.error('Error fetching customers:', error);
        } else {
            customers = data;
            renderCustomers();
        }
    }

    async function fetchOpportunities() {
        const { data, error } = await _supabase.from('opportunities').select('*');
        if (error) {
            console.error('Error fetching opportunities:', error);
        } else {
            opportunities = data;
            renderOpportunities();
            updateDashboard();
        }
    }

    // 4. Update existing functions to use Supabase instead of in-memory data
    function lookupCustomer() {
        const customerCode = document.getElementById("customerCode").value.toUpperCase();
        const customer = customers.find(c => c.accno === customerCode);
        if (customer) {
            document.getElementById("companyName").value = customer.companyName;
            document.getElementById("contactPerson").value = customer.contactPerson;
            document.getElementById("contactNumber").value = customer.number;
            document.getElementById("designation").value = customer.designation;
            document.getElementById("areaOfInterest").value = customer.areaOfInterest;
            document.getElementById("client").value = customer.companyName;
            document.getElementById("contactName").value = customer.contactPerson;
            document.getElementById("contactTitle").value = customer.designation;
            document.getElementById("contactDetails").value = customer.number;
            document.getElementById("areaInterest").value = customer.areaOfInterest;
            document.getElementById("finconCode").value = customer.accno;
        } else {
            // Clear fields if no customer is found
            document.getElementById("companyName").value = "";
            document.getElementById("contactPerson").value = "";
            document.getElementById("contactNumber").value = "";
            document.getElementById("designation").value = "";
            document.getElementById("areaOfInterest").value = "";
        }
    }
    
    async function addSalesOpportunity() {
        if (!currentUser) {
            alert("You must be logged in to add a sales opportunity.");
            return;
        }
        
        const newOpportunity = {
            finconCode: document.getElementById("finconCode").value,
            client: document.getElementById("client").value,
            quoteNumber: document.getElementById("quoteNumber").value,
            clientType: document.getElementById("clientType").value,
            contactName: document.getElementById("contactName").value,
            contactTitle: document.getElementById("contactTitle").value,
            contactDetails: document.getElementById("contactDetails").value,
            areaInterest: document.getElementById("areaInterest").value,
            openDate: document.getElementById("openDate").value,
            openPeriod: document.getElementById("openPeriod").value,
            opportunityValue: parseFloat(document.getElementById("opportunityValue").value),
            likelihood: document.getElementById("likelihood").value,
            modeOfSale: document.getElementById("modeOfSale").value,
            status: document.getElementById("status").value,
            salesMade: parseFloat(document.getElementById("salesMade").value) || 0,
            closeDate: document.getElementById("closeDate").value,
            closePeriod: document.getElementById("closePeriod").value,
            comments: document.getElementById("comments").value
        };

        const { data, error } = await _supabase.from('opportunities').insert([newOpportunity]);
        if (error) {
            console.error('Error adding sales opportunity:', error);
            alert("Error adding sales opportunity. See console for details.");
        } else {
            alert("Sales opportunity added successfully!");
            document.getElementById("inputForm").reset();
            fetchOpportunities(); // Re-fetch data to update the table
        }
    }

    function renderOpportunities() {
        const tableBody = document.getElementById("opportunitiesBody");
        tableBody.innerHTML = '';
        opportunities.forEach(opp => {
            const row = document.createElement('tr');
            const statusClass = opp.status.toLowerCase().replace(/\s/g, '-');
            row.innerHTML = `
                <td>${opp.finconCode}</td>
                <td>${opp.client}</td>
                <td>${opp.quoteNumber}</td>
                <td>${opp.clientType}</td>
                <td>${opp.contactName}</td>
                <td>${opp.contactTitle}</td>
                <td>${opp.areaInterest}</td>
                <td>${opp.openDate}</td>
                <td>${opp.opportunityValue.toFixed(2)}</td>
                <td>${opp.modeOfSale}</td>
                <td><span class="status-indicator status-${statusClass}">${opp.status}</span></td>
                <td>${opp.salesMade.toFixed(2)}</td>
                <td>${opp.closeDate}</td>
            `;
            tableBody.appendChild(row);
        });
    }

    function renderCustomers() {
        const tableBody = document.getElementById("customersBody");
        tableBody.innerHTML = '';
        customers.forEach(customer => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${customer.accno}</td>
                <td>${customer.companyName}</td>
                <td>${customer.contactPerson}</td>
                <td>${customer.number}</td>
                <td>${customer.designation}</td>
                <td>${customer.areaOfInterest}</td>
                <td>
                    <button onclick="editCustomer('${customer.accno}')">Edit</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    function filterCustomers() {
        const searchTerm = document.getElementById("customerSearch").value.toLowerCase();
        const filteredCustomers = customers.filter(customer =>
            Object.values(customer).some(value =>
                value.toString().toLowerCase().includes(searchTerm)
            )
        );
        const tableBody = document.getElementById("customersBody");
        tableBody.innerHTML = '';
        filteredCustomers.forEach(customer => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${customer.accno}</td>
                <td>${customer.companyName}</td>
                <td>${customer.contactPerson}</td>
                <td>${customer.number}</td>
                <td>${customer.designation}</td>
                <td>${customer.areaOfInterest}</td>
                <td>
                    <button onclick="editCustomer('${customer.accno}')">Edit</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    function updateDashboard() {
        const totalOpportunitiesValue = opportunities.reduce((sum, opp) => sum + opp.opportunityValue, 0);
        const totalSalesValue = opportunities.reduce((sum, opp) => sum + opp.salesMade, 0);
        const wonOpportunities = opportunities.filter(opp => opp.status === 'WON');
        const closeRate = opportunities.length > 0 ? (wonOpportunities.length / opportunities.length) * 100 : 0;

        document.getElementById('totalOpportunities').textContent = totalOpportunitiesValue.toFixed(2);
        document.getElementById('totalSales').textContent = totalSalesValue.toFixed(2);
        document.getElementById('closeRate').textContent = `${closeRate.toFixed(2)}%`;
        document.querySelector('.progress-fill').style.width = `${closeRate}%`;
    }

    // Initial render on page load
    document.addEventListener('DOMContentLoaded', () => {
        // This needs to be done here to ensure the form can be reset
        document.getElementById("inputForm").addEventListener("submit", (e) => e.preventDefault());
        // Fetch data when the page loads
        _supabase.auth.getSession().then(({ data: { session } }) => {
            if (session) {
                currentUser = session.user;
                fetchCustomers();
                fetchOpportunities();
            } else {
                alert("Please log in to use the CRM.");
            }
        });
    });

    // You will need to add a login form and a sign-up form to your HTML
    // and call these functions.
    // Example sign-up function:
    async function signUp(email, password) {
        const { user, error } = await _supabase.auth.signUp({
            email: email,
            password: password
        });
        if (error) {
            alert(error.message);
        } else {
            alert('Sign up successful! Please check your email for a confirmation link.');
        }
    }

    // Example sign-in function:
    async function signIn(email, password) {
        const { user, error } = await _supabase.auth.signInWithPassword({
            email: email,
            password: password
        });
        if (error) {
            alert(error.message);
        } else {
            alert('Login successful!');
        }
    }
</script>
